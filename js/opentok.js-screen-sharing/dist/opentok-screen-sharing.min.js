(function(){var e,n,i,r,t,o=function(e){var n="object"==typeof exports&&void 0!==require;if(n)return require(e);throw new Error(["Please include",e,"in your project"].join(" "))},a=this._||o("underscore"),s=this.$||o("jquery"),c=this.OTKAnalytics||o("opentok-solutions-logging"),l=['<div class="video-control circle share-screen" id="startScreenSharing"></div>'].join("\n"),d=['<div class="hidden" id="screenShareView">','<div class="wms-feed-main-video">','<div class="wms-feed-holder" id="videoHolderScreenShare"></div>','<div class="wms-feed-mask"></div>','<img src="/images/main/video-mask.png"/>',"</div>",'<div class="wms-feed-call-controls" id="feedControlsFromScreen">','<button class="wms-icon-screen active hidden" id="endScreenShareBtn"></button>',"</div>","</div>"].join("\n"),h=['<div id="dialog-form-chrome" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Chrome extension to share your screen. Install Screensharing Extension. Once you have installed, please, click the share screen button again.</p>",'<button id="btn-install-plugin-chrome" class="wms-btn-install">Accept</button>','<button id="btn-cancel-plugin-chrome" class="wms-cancel-btn-install"></button>',"</div>","</div>",'<div id="dialog-form-ff" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Firefox extension to share your screen. Install Screensharing Extension. Once you have installed, refresh your browser and click the share screen button again.</p>",'<a href="#" id="btn-install-plugin-ff" class="wms-btn-install" href="">Install extension</a>','<a href="#" id="btn-cancel-plugin-ff" class="wms-cancel-btn-install"></a>',"</div>","</div>"].join("\n"),u={clientVersion:"js-vsol-1.0.0",componentId:"screensharingAccPack",name:"guidScreensharingAccPack",actionInitialize:"Init",actionStart:"Start",actionEnd:"Stop",enableAnnotations:"EnableAnnotations",disableAnnotations:"DisableAnnotations",enableAudioScreenSharing:"EnableAudioScreenSharing",disableAudioScreenSharing:"DisableAudioScreenSharing",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},g=function(){var e=window.location.href,n={clientVersion:u.clientVersion,source:e,componentId:u.componentId,name:u.name};t=new c(n);var i={sessionId:r.id,connectionId:r.connection.connectionId,partnerId:r.apiKey};t.addSessionInfo(i)},f=function(e,n){var i={action:e,variation:n};t.logEvent(i)},p=function(n){s("body").append(h),s(e._screenSharingControls).append(l),s(n).append(d)},m=function(e){s("#startScreenSharing")[e?"show":"hide"]()},v=function(e,n){i&&i.triggerEvent(e,n)},S=function(){var n=function(n){var i=s.Deferred(),r=n||s("#videoHolderScreenShare");return e.publisher=OT.initPublisher(r,e.localScreenProperties,function(e){e?(v("screenSharingError",e),i.reject(a.extend(a.omit(e,"messsage"),{message:"Error starting the screen sharing"}))):i.resolve()}),i.promise()},r=s.Deferred();return e.annotation?(f(u.enableAnnotations,u.variationAttempt),i.setupExternalAnnotation().then(function(i){e.annotationWindow=i||null;var t=i.createContainerElements();n(t.publisher).then(function(){r.resolve(t.annotation)})})):n().then(function(){r.resolve()}),r.promise()},b=function(t){r.publish(e.publisher,function(r){if(r){var o=a.omit(r,"message");if(1500===r.code&&navigator.userAgent.indexOf("Firefox")!==-1)s("#dialog-form-ff").toggle();else{var c;c=1010===r.code?"Check your network connection":"Error sharing the screen",o.message=c,v("screenSharingError",o),f(u.actionStart,u.variationError)}}else e.annotation&&(i.linkAnnotation(e.publisher,t,e.annotationWindow),f(u.actionInitialize,u.variationSuccess)),n=!0,v("startScreenSharing"),f(u.actionStart,u.variationSuccess)})},w=function(){r.unpublish(e.publisher),e.publisher=null},x=function(){var e=s.Deferred();return"http:"===window.location.protocol&&(alert("Screensharing only works under 'https', please add 'https://' in front of your debugger url."),e.reject("https required")),OT.checkScreenSharingCapability(function(n){console.log("checkScreenSharingCapability",n),n.supported&&n.extensionRegistered?n.extensionInstalled?e.resolve():(s("#dialog-form-chrome").toggle(),e.reject("screensharing extension not installed")):"Firefox"===OT.$.browser()&&n.extensionInstalled?e.resolve():(alert("This browser does not support screen sharing! Please use Chrome, Firefox or IE!"),e.reject("browser support not available"))}),e.promise()},E=function(){f(u.actionStart,u.variationAttempt),x(e.extensionID,e.extensionPathFF).then(S).then(b).fail(function(e){console.log("Error starting screensharing: ",e),f(u.actionStart,u.variationError)})},y=function(e){f(u.actionEnd,u.variationAttempt),w(),n=!1,e&&m(!1),v("endScreenSharing"),f(u.actionEnd,u.variationSuccess)},I=function(){if(i){var e=["startScreenSharing","endScreenSharing","screenSharingError"];i.registerEvents(e)}},A=function(){var r=a.throttle(function(){n?y():E()},750);s("#startScreenSharing").on("click",r),s("#btn-install-plugin-chrome").on("click",function(){chrome.webstore.install(["https://chrome.google.com/webstore/detail/",e.extensionID].join(""),function(e){console.log("success",e)},function(e){console.log("error",e)}),s("#dialog-form-chrome").toggle()}),s("#btn-cancel-plugin-chrome").on("click",function(){s("#dialog-form-chrome").toggle()}),s("#btn-install-plugin-ff").prop("href",e.extensionPathFF),s("#btn-install-plugin-ff").on("click",function(){s("#dialog-form-ff").toggle()}),s("#btn-cancel-plugin-ff").on("click",function(){s("#dialog-form-ff").toggle()}),i&&(i.registerEventListener("startCall",function(){m(!0)}),i.registerEventListener("endCall",function(){n?y(!0):m(!1)}),i.registerEventListener("annotationWindowClosed",function(){y()}))},k=function(e,n){if("Chrome"===OT.$.browser()){if(!e||!e.length)throw new Error("Error starting the screensharing. Chrome extensionID required");s("<link/>",{rel:"chrome-webstore-item",href:["https://chrome.google.com/webstore/detail/",e].join("")}).appendTo("head"),OT.registerScreenSharingExtension("chrome",e,2)}if(!("Firefox"!==OT.$.browser()||n&&n.length))throw new Error("Error starting the screensharing. Firefox screensharing extension required")},P=function(e){if(!a.property("session",e))throw new Error("Screen Share Acc Pack requires an OpenTok session");r=a.property("session")(e),i=a.property("accPack")(e),k(a.property("extensionID")(e),a.property("extensionPathFF")(e))},C=function(n){e=this,P(n);var i=["annotation","extensionURL","extensionID","extensionPathFF","screensharingParent","localScreenProperties"];a.extend(e,a.defaults(a.pick(n,i)),{screenSharingParent:"#videoContainer",_screenSharingControls:"#feedControls"}),p(e.screensharingParent),I(),A(),g(),f(u.actionInitialize,u.variationAttempt),f(u.actionInitialize,u.variationSuccess)};C.prototype={constructor:C,extensionAvailable:x,start:E,end:y},"object"==typeof exports?module.exports=C:"function"==typeof define&&define.amd?define(function(){return C}):this.ScreenSharingAccPack=C}).call(this);