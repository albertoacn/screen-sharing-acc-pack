(function(){var e,n,i;"object"==typeof module&&"object"==typeof module.exports?(e=require("underscore"),n=require("jquery"),i=require("opentok-solutions-logging")):(e=this._,n=this.$,i=this.OTKAnalytics);var r,t,o,a,s,c=['<div class="video-control circle share-screen" id="startScreenSharing"></div>'].join("\n"),l=['<div class="hidden" id="screenShareView">','<div class="wms-feed-main-video">','<div class="wms-feed-holder" id="videoHolderScreenShare"></div>','<div class="wms-feed-mask"></div>','<img src="/images/main/video-mask.png"/>',"</div>",'<div class="wms-feed-call-controls" id="feedControlsFromScreen">','<button class="wms-icon-screen active hidden" id="endScreenShareBtn"></button>',"</div>","</div>"].join("\n"),d=['<div id="dialog-form-chrome" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Chrome extension to share your screen. Install Screensharing Extension. Once you have installed, please, click the share screen button again.</p>",'<button id="btn-install-plugin-chrome" class="wms-btn-install">Accept</button>','<button id="btn-cancel-plugin-chrome" class="wms-cancel-btn-install"></button>',"</div>","</div>",'<div id="dialog-form-ff" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Firefox extension to share your screen. Install Screensharing Extension. Once you have installed, refresh your browser and click the share screen button again.</p>",'<a href="#" id="btn-install-plugin-ff" class="wms-btn-install" href="">Install extension</a>','<a href="#" id="btn-cancel-plugin-ff" class="wms-cancel-btn-install"></a>',"</div>","</div>"].join("\n"),h={clientVersion:"js-vsol-1.0.0",componentId:"screensharingAccPack",name:"guidScreensharingAccPack",actionInitialize:"Init",actionStart:"Start",actionEnd:"Stop",enableAnnotations:"EnableAnnotations",disableAnnotations:"DisableAnnotations",enableAudioScreenSharing:"EnableAudioScreenSharing",disableAudioScreenSharing:"DisableAudioScreenSharing",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},u=function(){var e=window.location.href,n={clientVersion:h.clientVersion,source:e,componentId:h.componentId,name:h.name};s=new i(n);var r={sessionId:a.id,connectionId:a.connection.connectionId,partnerId:a.apiKey};s.addSessionInfo(r)},g=function(e,n){var i={action:e,variation:n};s.logEvent(i)},f=function(e){n("body").append(d),n(r._screenSharingControls).append(c),n(e).append(l)},p=function(e){n("#startScreenSharing")[e?"show":"hide"]()},m=function(e,n){o&&o.triggerEvent(e,n)},v=function(){var i=function(i){var t=n.Deferred(),o=i||n("#videoHolderScreenShare");return r.publisher=OT.initPublisher(o,r.localScreenProperties,function(n){n?(m("screenSharingError",n),t.reject(e.extend(e.omit(n,"messsage"),{message:"Error starting the screen sharing"}))):t.resolve()}),t.promise()},t=n.Deferred();return r.annotation?(g(h.enableAnnotations,h.variationAttempt),o.setupExternalAnnotation().then(function(e){r.annotationWindow=e||null;var n=e.createContainerElements();i(n.publisher).then(function(){t.resolve(n.annotation)})})):i().then(function(){t.resolve()}),t.promise()},S=function(i){a.publish(r.publisher,function(a){if(a){var s=e.omit(a,"message");if(1500===a.code&&navigator.userAgent.indexOf("Firefox")!==-1)n("#dialog-form-ff").toggle();else{var c;c=1010===a.code?"Check your network connection":"Error sharing the screen",s.message=c,m("screenSharingError",s),g(h.actionStart,h.variationError)}}else r.annotation&&(o.linkAnnotation(r.publisher,i,r.annotationWindow),g(h.actionInitialize,h.variationSuccess)),t=!0,m("startScreenSharing"),g(h.actionStart,h.variationSuccess)})},b=function(){a.unpublish(r.publisher),r.publisher=null},w=function(){var e=n.Deferred();return"http:"===window.location.protocol&&(alert("Screensharing only works under 'https', please add 'https://' in front of your debugger url."),e.reject("https required")),OT.checkScreenSharingCapability(function(i){console.log("checkScreenSharingCapability",i),i.supported&&i.extensionRegistered?i.extensionInstalled?e.resolve():(n("#dialog-form-chrome").toggle(),e.reject("screensharing extension not installed")):"Firefox"===OT.$.browser()&&i.extensionInstalled?e.resolve():(alert("This browser does not support screen sharing! Please use Chrome, Firefox or IE!"),e.reject("browser support not available"))}),e.promise()},x=function(){g(h.actionStart,h.variationAttempt),w(r.extensionID,r.extensionPathFF).then(v).then(S).fail(function(e){console.log("Error starting screensharing: ",e),g(h.actionStart,h.variationError)})},E=function(e){g(h.actionEnd,h.variationAttempt),b(),t=!1,e&&p(!1),m("endScreenSharing"),g(h.actionEnd,h.variationSuccess)},y=function(){if(o){var e=["startScreenSharing","endScreenSharing","screenSharingError"];o.registerEvents(e)}},I=function(){var i=e.throttle(function(){t?E():x()},750);n("#startScreenSharing").on("click",i),n("#btn-install-plugin-chrome").on("click",function(){chrome.webstore.install(["https://chrome.google.com/webstore/detail/",r.extensionID].join(""),function(e){console.log("success",e)},function(e){console.log("error",e)}),n("#dialog-form-chrome").toggle()}),n("#btn-cancel-plugin-chrome").on("click",function(){n("#dialog-form-chrome").toggle()}),n("#btn-install-plugin-ff").prop("href",r.extensionPathFF),n("#btn-install-plugin-ff").on("click",function(){n("#dialog-form-ff").toggle()}),n("#btn-cancel-plugin-ff").on("click",function(){n("#dialog-form-ff").toggle()}),o&&(o.registerEventListener("startCall",function(){p(!0)}),o.registerEventListener("endCall",function(){t?E(!0):p(!1)}),o.registerEventListener("annotationWindowClosed",function(){E()}))},A=function(e,i){if("Chrome"===OT.$.browser()){if(!e||!e.length)throw new Error("Error starting the screensharing. Chrome extensionID required");n("<link/>",{rel:"chrome-webstore-item",href:["https://chrome.google.com/webstore/detail/",e].join("")}).appendTo("head"),OT.registerScreenSharingExtension("chrome",e,2)}if(!("Firefox"!==OT.$.browser()||i&&i.length))throw new Error("Error starting the screensharing. Firefox screensharing extension required")},k=function(n){if(!e.property("session",n))throw new Error("Screen Share Acc Pack requires an OpenTok session");a=e.property("session")(n),o=e.property("accPack")(n),A(e.property("extensionID")(n),e.property("extensionPathFF")(n))},C=function(n){r=this,k(n);var i=["annotation","extensionURL","extensionID","extensionPathFF","screensharingParent","localScreenProperties"];e.extend(r,e.defaults(e.pick(n,i)),{screenSharingParent:"#videoContainer",_screenSharingControls:"#feedControls"}),f(r.screensharingParent),y(),I(),u(),g(h.actionInitialize,h.variationAttempt),g(h.actionInitialize,h.variationSuccess)};C.prototype={constructor:C,extensionAvailable:w,start:x,end:E},"object"==typeof exports?module.exports=C:"function"==typeof define&&define.amd?define(function(){return C}):this.ScreenSharingAccPack=C}).call(this);