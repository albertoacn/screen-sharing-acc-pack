(function(){var e,n,r,o,i=['<div class="video-control circle share-screen" id="startScreenSharing"></div>'].join("\n"),t=['<div class="hidden" id="screenShareView">','<div class="wms-feed-main-video">','<div class="wms-feed-holder" id="videoHolderScreenShare"></div>','<div class="wms-feed-mask"></div>','<img src="/images/main/video-mask.png"/>',"</div>",'<div class="wms-feed-call-controls" id="feedControlsFromScreen">','<button class="wms-icon-screen active hidden" id="endScreenShareBtn"></button>',"</div>","</div>"].join("\n"),s=['<div id="dialog-form-chrome" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Chrome extension to share your screen. Install Screensharing Extension. Once you have installed, please, click the share screen button again.</p>",'<button id="btn-install-plugin-chrome" class="wms-btn-install">Accept</button>','<button id="btn-cancel-plugin-chrome" class="wms-cancel-btn-install"></button>',"</div>","</div>",'<div id="dialog-form-ff" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Firefox extension to share your screen. Install Screensharing Extension. Once you have installed, refresh your browser and click the share screen button again.</p>",'<a href="#" id="btn-install-plugin-ff" class="wms-btn-install" href="">Install extension</a>','<a href="#" id="btn-cancel-plugin-ff" class="wms-cancel-btn-install"></a>',"</div>","</div>"].join("\n"),a=function(n){$("body").append(s),$(e._screenSharingControls).append(i),$(n).append(t)},c=function(e){$("#startScreenSharing")[e?"show":"hide"]()},l=function(e,n){r&&r.triggerEvent(e,n)},d=function(){var n=function(n){var r=$.Deferred(),o=n||$("#videoHolderScreenShare");return e.publisher=OT.initPublisher(o,e.localScreenProperties,function(e){e?(l("screenSharingError",e),r.reject(_.extend(_.omit(e,"messsage"),{message:"Error starting the screen sharing"}))):r.resolve()}),r.promise()},o=$.Deferred();return e.annotation?r.setupExternalAnnotation().then(function(r){e.annotationWindow=r||null;var i=r.createContainerElements();n(i.publisher).then(function(){o.resolve(i.annotation)})}):n().then(function(){o.resolve()}),o.promise()},h=function(i){o.publish(e.publisher,function(o){if(o){var t=_.omit(o,"message");if(1500===o.code&&navigator.userAgent.indexOf("Firefox")!==-1)$("#dialog-form-ff").toggle();else{var s;s=1010===o.code?"Check your network connection":"Error sharing the screen",t.message=s,l("screenSharingError",t)}}else e.annotation&&r.linkAnnotation(e.publisher,i,e.annotationWindow),n=!0,l("startScreenSharing")})},f=function(){o.unpublish(e.publisher),e.publisher=null},g=function(){var e=$.Deferred();return"http:"===window.location.protocol&&(alert("Screensharing only works under 'https', please add 'https://' in front of your debugger url."),e.reject("https required")),OT.checkScreenSharingCapability(function(n){console.log("checkScreenSharingCapability",n),n.supported&&n.extensionRegistered?n.extensionInstalled?e.resolve():($("#dialog-form-chrome").toggle(),e.reject("screensharing extension not installed")):"Firefox"===OT.$.browser()&&n.extensionInstalled?e.resolve():(alert("This browser does not support screen sharing! Please use Chrome, Firefox or IE!"),e.reject("browser support not available"))}),e.promise()},u=function(){g(e.extensionID,e.extensionPathFF).then(d).then(h).fail(function(e){console.log("Error starting screensharing: ",e)})},p=function(e){f(),n=!1,e&&c(!1),l("endScreenSharing")},m=function(){if(r){var e=["startScreenSharing","endScreenSharing","screenSharingError"];r.registerEvents(e)}},v=function(){var o=_.throttle(function(){n?p():u()},750);$("#startScreenSharing").on("click",o),$("#btn-install-plugin-chrome").on("click",function(){chrome.webstore.install(["https://chrome.google.com/webstore/detail/",e.extensionID].join(""),function(e){console.log("success",e)},function(e){console.log("error",e)}),$("#dialog-form-chrome").toggle()}),$("#btn-cancel-plugin-chrome").on("click",function(){$("#dialog-form-chrome").toggle()}),$("#btn-install-plugin-ff").prop("href",e.extensionPathFF),$("#btn-install-plugin-ff").on("click",function(){$("#dialog-form-ff").toggle()}),$("#btn-cancel-plugin-ff").on("click",function(){$("#dialog-form-ff").toggle()}),r&&(r.registerEventListener("startCall",function(){c(!0)}),r.registerEventListener("endCall",function(){n?p(!0):c(!1)}),r.registerEventListener("annotationWindowClosed",function(){p()}))},b=function(e,n){if("Chrome"===OT.$.browser()){if(!e||!e.length)throw new Error("Error starting the screensharing. Chrome extensionID required");$("<link/>",{rel:"chrome-webstore-item",href:["https://chrome.google.com/webstore/detail/",e].join("")}).appendTo("head"),OT.registerScreenSharingExtension("chrome",e,2)}if(!("Firefox"!==OT.$.browser()||n&&n.length))throw new Error("Error starting the screensharing. Firefox screensharing extension required")},S=function(e){if(!_.property("session",e))throw new Error("Screen Share Acc Pack requires an OpenTok session");o=_.property("session")(e),r=_.property("accPack")(e),b(_.property("extensionID")(e),_.property("extensionPathFF")(e))},w=function(n){e=this,S(n);var r=["annotation","extensionURL","extensionID","extensionPathFF","screensharingParent","localScreenProperties"];_.extend(e,_.defaults(_.pick(n,r)),{screenSharingParent:"#videoContainer",_screenSharingControls:"#feedControls"}),a(e.screensharingParent),m(),v()};w.prototype={constructor:w,extensionAvailable:g,start:u,end:p},"object"==typeof exports?module.exports=w:"function"==typeof define&&define.amd?define(function(){return w}):this.ScreenSharingAccPack=w}).call(this);