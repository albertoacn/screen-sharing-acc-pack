window.OTSolution=window.OTSolution||{},OTSolution.Annotations=function(t){function e(t,e,i){for(var o=e.split(" "),n=0,s=o.length;n<s;n++)t.addEventListener(o[n],i,!0)}function i(t,e){0===s.width&&(s.width=n.parent.getBoundingClientRect().width),0===s.height&&(s.height=n.parent.getBoundingClientRect().height);var i,o=e?t.canvas.width:n.parent.clientWidth,a=e?t.canvas.height:n.parent.clientHeight,l=e?t.canvas.offsetLeft:s.offsetLeft,c=e?t.canvas.offsetTop:s.offsetTop,d=s.width/o,h=s.height/a,g=t.offsetX||t.pageX-l||t.changedTouches&&t.changedTouches[0].pageX-l,m=t.offsetY||t.pageY-c||t.changedTouches&&t.changedTouches[0].pageY-c,p=g*d,v=m*h,y=e?t.selectedItem:n.selectedItem;if(y)if("OT_pen"===y.id)switch(t.type){case"mousedown":case"touchstart":f.dragging=!0,f.lastX=p,f.lastY=v,n.isStartPoint=!0;break;case"mousemove":case"touchmove":f.dragging&&(i={id:n.videoFeed.stream.connection.connectionId,fromId:n.session.connection.connectionId,fromX:f.lastX,fromY:f.lastY,toX:p,toY:v,color:e?t.userColor:n.userColor,lineWidth:n.lineWidth,videoWidth:n.videoFeed.videoElement().clientWidth,videoHeight:n.videoFeed.videoElement().clientHeight,canvasWidth:s.width,canvasHeight:s.height,mirrored:r,startPoint:n.isStartPoint,endPoint:!1,selectedItem:y},W(i,!0),f.lastX=p,f.lastY=v,!e&&P(i),n.isStartPoint=!1);break;case"mouseup":case"touchend":case"mouseout":f.dragging=!1,OTSolution.Annotations.Analytics.logEvent({widgetVersion:n.widgetVersion,guid:OTSolution.Annotations.Analytics.get_uuid(),source:window.location.href,logVersion:"1",clientSystemTime:(new Date).getTime(),action:"an_draw",variation:"an_pen",sessionId:n.session.sessionId,partnerId:n.videoFeed.session.apiKey,connectionId:n.session.connection.connectionId,selectedItem:y})}else if("OT_text"===y.id)i={id:n.videoFeed.stream.connection.connectionId,fromId:n.session.connection.connectionId,fromX:p,fromY:v+t.inputHeight,color:t.userColor,font:t.font,text:t.text,videoWidth:n.videoFeed.videoElement().clientWidth,videoHeight:n.videoFeed.videoElement().clientHeight,canvasWidth:s.width,canvasHeight:s.height,mirrored:r,selectedItem:y},W(i),!e&&P(i);else if(y&&y.points)switch(f.mX=p,f.mY=v,t.type){case"mousedown":case"touchstart":f.isDrawing=!0,f.dragging=!0,f.startX=p,f.startY=v;break;case"mousemove":case"touchmove":f.dragging&&(i={color:e?t.userColor:n.userColor,lineWidth:e?t.lineWidth:n.lineWidth,selectedItem:y},W(i,!0));break;case"mouseup":case"touchend":f.isDrawing=!1,OTSolution.Annotations.Analytics.logEvent({widgetVersion:n.widgetVersion,guid:OTSolution.Annotations.Analytics.get_uuid(),source:window.location.href,logVersion:"1",clientSystemTime:(new Date).getTime(),action:"an_draw",variation:"an_shape",sessionId:n.session.sessionId,partnerId:n.videoFeed.session.apiKey,connectionId:n.session.connection.connectionId});var b=y.points;if(2===b.length)i={id:n.videoFeed.stream.connection.connectionId,fromId:n.session.connection.connectionId,fromX:f.startX,fromY:f.startY,toX:f.mX,toY:f.mY,color:e?t.userColor:n.userColor,lineWidth:e?t.lineWidth:n.lineWidth,videoWidth:n.videoFeed.videoElement().clientWidth,videoHeight:n.videoFeed.videoElement().clientHeight,canvasWidth:s.width,canvasHeight:s.height,mirrored:r,smoothed:!1,startPoint:!0,endPoint:!0,selectedItem:y},u.push(i),!e&&P(i);else{for(var I=A(b),w=0;w<b.length;w++){var x=!1,T=!1,_=f.startX+I.x*b[w][0],O=f.startY+I.y*b[w][1];0===w?(f.lastX=_,f.lastY=O,x=!0):w===b.length-1&&(T=!0),i={id:n.videoFeed.stream.connection.connectionId,fromId:n.session.connection.connectionId,fromX:f.lastX,fromY:f.lastY,toX:_,toY:O,color:e?t.userColor:n.userColor,lineWidth:e?t.lineWidth:n.lineWidth,videoWidth:n.videoFeed.videoElement().clientWidth,videoHeight:n.videoFeed.videoElement().clientHeight,canvasWidth:s.width,canvasHeight:s.height,mirrored:r,smoothed:y.enableSmoothing,startPoint:x,endPoint:T},u.push(i),!e&&P(i),f.lastX=_,f.lastY=O}W(null)}f.dragging=!1}}t=t||{},this.widgetVersion="js-1.0.0-beta",this.parent=t.container,this.videoFeed=t.feed;var o=t.externalWindow?t.externalWindow.document:window.document,n=this;if(this.parent){var s=document.createElement("canvas");s.setAttribute("id","opentok_canvas"),s.style.position="absolute",this.parent.appendChild(s),s.setAttribute("width",this.parent.clientWidth+"px"),s.style.width=window.getComputedStyle(this.parent).width,s.setAttribute("height",this.parent.clientHeight+"px"),s.style.height=window.getComputedStyle(this.parent).height}var a,r,l,c,n=this,d=[],h=[],u=[],g=[],m=[],f={dragging:!1};r=(" "+n.videoFeed.element.className+" ").indexOf(" OT_mirrored ")>-1,l=(" "+n.videoFeed.element.className+" ").indexOf(" OT_fit-mode-cover ")>-1,this.canvas=function(){return s},this.link=function(t){this.session=t},this.changeColor=function(t){n.userColor=t,n.lineWidth||(n.lineWidth=2)},this.changeLineWidth=function(t){this.lineWidth=t},this.selectItem=function(t){n.overlay&&(n.overlay.style.display="none",n.overlay=null),"OT_capture"===t.id?(n.selectedItem=t,n.overlay?n.overlay.style="inline":(n.overlay=document.createElement("div"),n.overlay.style.position="absolute",n.overlay.style.width=n.parent.clientWidth+"px",n.overlay.style.height=n.parent.clientHeight+"px",n.overlay.style.background='rgba(0,0,0,0.4) url("../images/annotation/camera.png") no-repeat center',n.overlay.style.backgroundSize="50px 50px",n.overlay.style.cursor="pointer",n.overlay.style.opacity=0,n.parent.appendChild(n.overlay),n.parent.onmouseover=function(){n.overlay.style.opacity=1},n.parent.onmouseout=function(){n.overlay.style.opacity=0},n.overlay.onclick=function(){n.captureScreenshot()})):t.id.indexOf("OT_line_width")!==-1?t.size&&n.changeLineWidth(t.size):n.selectedItem=t},this.colors=function(t){this.colors=t,this.changeColor(t[0])},this.clear=function(){X(!1,n.session.connection.connectionId),n.session&&n.session.signal({type:"otAnnotation_clear"})},this.captureScreenshot=function(){OTSolution.Annotations.Analytics.logEvent({widgetVersion:n.widgetVersion,guid:OTSolution.Annotations.Analytics.get_uuid(),source:window.location.href,logVersion:"1",clientSystemTime:(new Date).getTime(),action:"an_capture",variation:"",sessionId:n.session.sessionId,partnerId:n.videoFeed.session.apiKey,connectionId:n.session.connection.connectionId});var t=document.createElement("canvas");t.width=s.width,t.height=s.height;var e=n.videoFeed.videoWidth(),i=n.videoFeed.videoHeight(),o=1,a=0,c=0;l?(e<i?(o=s.width/e,e=s.width,i*=o):(o=s.height/i,i=s.height,e*=o),a=(e-s.width)/2,c=(i-s.height)/2):e>i?(o=s.width/e,e=s.width,i*=o):(o=s.height/i,i=s.height,e*=o);var h=new Image;h.onload=function(){var o=t.getContext("2d");r&&(o.translate(e,0),o.scale(-1,1)),o.drawImage(h,a,c,e,i),r&&(o.translate(e,0),o.scale(-1,1)),o.drawImage(s,0,0),d.forEach(function(e){e.call(n,t.toDataURL())}),t=null},h.src="data:image/png;base64,"+n.videoFeed.getImgData()},this.onScreenCapture=function(t){d.push(t)},this.onResize=function(){u=[],E(g,!0),m.forEach(function(t){i(t,!0)})},e(s,"mousedown mousemove mouseup mouseout touchstart touchmove touchend",function(t){var e=n.selectedItem&&"OT_text"===n.selectedItem.id,o="mousemove"===t.type&&!f.dragging;e||o||(t.preventDefault(),t.selectedItem=n.selectedItem,t.selectedItem&&(t.canvas={width:s.width,height:s.height,offsetLeft:s.offsetLeft,offsetTop:s.offsetTop},t.userColor=n.userColor,t.lineWidth=n.lineWidth,m.push(t)),i(t))});var p,v="textAnnotation",y=!1,b=function(t){t.preventDefault(),n.selectedItem&&"OT_text"!==n.selectedItem.id||y||(y=!0,t.selectedItem=n.selectedItem,_(t))},I=function(t){13===t.which&&T(),27===t.which&&(o.getElementById(v).remove(),p=null),y=!1},w=function(){o.addEventListener("keydown",I)},x=function(){o.removeEventListener("keydown",I)},T=function(){var t=o.getElementById(v);t.clientHeight;return t.value?(t.remove(),x(),p.text=t.value,p.font="16px Arial",p.userColor=n.userColor,p.canvas={width:s.width,height:s.height,offsetLeft:s.offsetLeft,offsetTop:s.offsetTop},m.push(p),void i(p)):void(p=null)},_=function(t){var e=o.createElement("input");e.setAttribute("type","text"),e.style.position="absolute",e.style.top=t.clientY+"px",e.style.left=t.clientX+"px",e.style.background="rgba(255,255,255, .5)",e.style.width="100px",e.style.maxWidth="200px",e.style.border="1px dashed red",e.style.fontSize="16px",e.style.color=n.userColor,e.style.fontFamily="Arial",e.style.zIndex="1001",e.setAttribute("data-canvas-origin",JSON.stringify({x:t.offsetX,y:t.offsetY})),e.id=v,o.body.appendChild(e),e.focus(),p=t,p.inputHeight=e.clientHeight,w()};e(s,"click",b);var W=function(t,e){a||(a=s.getContext("2d"),a.lineCap="round",a.lineJoin="round",a.fillStyle="solid"),a.clearRect(0,0,s.width,s.height),u.forEach(function(t){a.strokeStyle=t.color,a.lineWidth=t.lineWidth,t.smoothed=!!t.smoothed,t.startPoint=!!t.startPoint;var e=!1,i=!!t.selectedItem&&"Text"===t.selectedItem.title&&t.text;i?(a.font=t.font,a.fillStyle=t.color,a.fillText(t.text,t.fromX,t.fromY)):t.smoothed?(t.startPoint?n.isStartPoint=!0:n.isStartPoint&&(e=!0,n.isStartPoint=!1),t.startPoint?(a.closePath(),a.beginPath()):e?a.moveTo((t.fromX+t.toX)/2,(t.fromY+t.toY)/2):(a.quadraticCurveTo(t.fromX,t.fromY,(t.fromX+t.toX)/2,(t.fromY+t.toY)/2),a.stroke())):(a.beginPath(),a.moveTo(t.fromX,t.fromY),a.lineTo(t.toX,t.toY),a.stroke(),a.closePath())});var i=e?t.selectedItem:n.selectedItem;!i||"Pen"!==i.title&&"Text"!==i.title?f.isDrawing&&(t&&(a.strokeStyle=t.color,a.lineWidth=t.lineWidth),i&&i.points&&O(a,n.selectedItem.points)):t&&("Pen"===i.title&&(a.strokeStyle=t.color,a.lineWidth=t.lineWidth,a.beginPath(),a.moveTo(t.fromX,t.fromY),a.lineTo(t.toX,t.toY),a.stroke(),a.closePath()),"Text"===i.title&&(a.font=t.font,a.fillStyle=t.color,a.fillText(t.text,t.fromX,t.fromY)),u.push(t))},O=function(t,e){var i=A(e);if(t.beginPath(),2===e.length)t.moveTo(f.startX,f.startY),t.lineTo(f.mX,f.mY);else for(var o=0;o<e.length;o++){var s=f.startX+i.x*e[o][0],a=f.startY+i.y*e[o][1];n.selectedItem.enableSmoothing?0===o||(1===o?(t.moveTo((s+f.lastX)/2,(a+f.lastY)/2),f.lastX=(s+f.lastX)/2,f.lastX=(a+f.lastY)/2):(t.quadraticCurveTo(f.lastX,f.lastY,(s+f.lastX)/2,(a+f.lastY)/2),f.lastX=(s+f.lastX)/2,f.lastY=(a+f.lastY)/2)):0===o?t.moveTo(s,a):t.lineTo(s,a),f.lastX=s,f.lastY=a}t.stroke(),t.closePath()},A=function(t){for(var e=Number.MAX_VALUE,i=Number.MAX_VALUE,o=0,n=0,s=0;s<t.length;s++)t[s][0]<e?e=t[s][0]:t[s][0]>o&&(o=t[s][0]),t[s][1]<i?i=t[s][1]:t[s][1]>n&&(n=t[s][1]);var a=Math.abs(o-e),r=Math.abs(n-i),l=(f.mX-f.startX)/a,c=(f.mY-f.startY)/r;return{x:l,y:c}},k=function(t,e,i){var o={width:t.canvasWidth,height:t.canvasHeight},a={width:t.videoWidth,height:t.videoHeight},l={width:n.videoFeed.videoElement().clientWidth,height:n.videoFeed.videoElement().clientHeight},c=1,d=s.width/s.height;l.width/l.height,o.width/o.height,a.width/a.height;c=d<0?s.width/o.width:s.height/o.height;var h=s.width/2,m=s.height/2,f=o.width/2,p=o.height/2;t.fromX=h-c*(f-t.fromX),t.fromY=m-c*(p-t.fromY),t.toX=h-c*(f-t.toX),t.toY=m-c*(p-t.toY),t.mirrored=!!t.mirrored,t.mirrored&&(t.fromX=s.width-t.fromX,t.toX=s.width-t.toX),r&&(t.fromX=s.width-t.fromX,t.toX=s.width-t.toX);var v=JSON.parse(JSON.stringify(t));v.canvasWidth=s.width,v.canvasHeight=s.height,v.videoWidth=l.width,v.videoHeight=l.height,e?g[i]=v:g.push(v),u.push(t),W(null)},E=function(t,e){t.forEach(function(t,i){t.id===n.videoFeed.stream.connection.connectionId&&k(t,e,i)})},X=function(t,e){u=u.filter(function(t){return console.log(t.fromId),t.fromId!==e}),t?g=[]:(n.session&&n.session.signal({type:"otAnnotation_clear"}),m=[]),W()};n.videoFeed.session&&n.videoFeed.session.on({"signal:otAnnotation_pen":function(t){t.from.connectionId!==n.session.connection.connectionId&&E(JSON.parse(t.data))},"signal:otAnnotation_text":function(t){t.from.connectionId!==n.session.connection.connectionId&&E(JSON.parse(t.data))},"signal:otAnnotation_history":function(t){c&&c!==t.from.connectionId||(c=t.from.connectionId,E(JSON.parse(t.data)))},"signal:otAnnotation_clear":function(t){t.from.connectionId!==n.session.connection.connectionId&&X(!0,t.from.connectionId)},connectionCreated:function(t){u.length>0&&t.connection.connectionId!==n.session.connection.connectionId&&S("otWhiteboard_history",u,t.connection)}});var C,S=function(t,e,i){for(var o=e.slice(),s=function(t){t&&TB.error(t)};o.length;){var a=o.splice(0,Math.min(o.length,32)),r={type:t,data:JSON.stringify(a)};i&&(r.to=i),n.session.signal(r,s)}},P=function(t){n.session&&(h.push(t),C||(C=setTimeout(function(){S("otAnnotation_pen",h),h=[],C=null},100)))}},OTSolution.Annotations.Toolbar=function(t){var e=this,i=this;t||(t={}),this.session=t.session,this.parent=t.container,this.externalWindow=t.externalWindow,this.backgroundColor=t.backgroundColor||"rgba(0, 0, 0, 0.7)",this.buttonWidth=t.buttonWidth||"40px",this.buttonHeight=t.buttonHeight||"40px",this.iconWidth=t.iconWidth||"30px",this.iconHeight=t.iconHeight||"30px",this.items=t.items||[{id:"OT_pen",title:"Pen",icon:"../images/annotation/freehand.png",selectedIcon:"../images/annotation/freehand_selected.png"},{id:"OT_line",title:"Line",icon:"../images/annotation/line.png",selectedIcon:"../images/annotation/line_selected.png",points:[[0,0],[0,1]]},{id:"OT_shapes",title:"Shapes",icon:"../images/annotation/shapes.png",items:[{id:"OT_arrow",title:"Arrow",icon:"../images/annotation/arrow.png",points:[[0,1],[3,1],[3,0],[5,2],[3,4],[3,3],[0,3],[0,1]]},{id:"OT_rect",title:"Rectangle",icon:"../images/annotation/rectangle.png",points:[[0,0],[1,0],[1,1],[0,1],[0,0]]},{id:"OT_oval",title:"Oval",icon:"../images/annotation/oval.png",enableSmoothing:!0,points:[[0,.5],[.5+.5*Math.cos(5*Math.PI/4),.5+.5*Math.sin(5*Math.PI/4)],[.5,0],[.5+.5*Math.cos(7*Math.PI/4),.5+.5*Math.sin(7*Math.PI/4)],[1,.5],[.5+.5*Math.cos(Math.PI/4),.5+.5*Math.sin(Math.PI/4)],[.5,1],[.5+.5*Math.cos(3*Math.PI/4),.5+.5*Math.sin(3*Math.PI/4)],[0,.5],[.5+.5*Math.cos(5*Math.PI/4),.5+.5*Math.sin(5*Math.PI/4)]]}]},{id:"OT_text",title:"Text",icon:"../images/annotation/text.png",selectedIcon:"../images/annotation/text.png"},{id:"OT_colors",title:"Colors",icon:"",items:{}},{id:"OT_line_width",title:"Line Width",icon:"../images/annotation/line_width.png",items:{}},{id:"OT_clear",title:"Clear",icon:"../images/annotation/clear.png"},{id:"OT_capture",title:"Capture",icon:"../images/annotation/camera.png",selectedIcon:"../images/annotation/camera_selected.png"}],this.colors=t.colors||["#1abc9c","#2ecc71","#3498db","#9b59b6","#34495e","#16a085","#27ae60","#2980b9","#8e44ad","#2c3e50","#f1c40f","#e67e22","#e74c3c","#ecf0f1","#95a5a6","#f39c12","#d35400","#c0392b","#bdc3c7","#7f8c8d"],this.cbs=[];var o,n=[],s=function(t,e,o){var n=this,s=i.externalWindow?i.externalWindow.document:document;this.getElm=function(t){return"string"==typeof t?s.querySelector(t):t},this.render=function(){var t=this,e="";t.colors.forEach(function(i){e+=t.options.template.replace(/\{color\}/g,i)}),t.elm.innerHTML=e},this.close=function(){this.elm.style.display="none"},this.open=function(){this.elm.style.display=this.options.style.display},this.colorChosen=function(t){this.cbs.push(t)},this.set=function(t,e){var i=this;i.color=t,e!==!1&&i.cbs.forEach(function(e){e.call(i,t)})},o=o||{},o.openEvent=o.openEvent||"click",o.style=Object(o.style),o.style.display=o.style.display||"block",o.template=o.template||'<div class="color-choice" data-col="{color}" style="background-color: {color}"></div>',n.elm=n.getElm(t),n.cbs=[],n.colors=e,n.options=o,n.render(),n.elm.addEventListener("click",function(t){var e=t.target.getAttribute("data-col");e&&(n.set(e),n.close())}),o.autoclose!==!1&&n.close()};this.createPanel=function(t){if(i.parent){var r=t?t.document:document;o=r.createElement("div"),o.setAttribute("id","OT_toolbar"),o.setAttribute("class","OT_panel"),o.style.width="100%",o.style.height="100%",o.style.backgroundColor=this.backgroundColor,this.parent.appendChild(o),this.parent.style.position="relative",this.parent.zIndex=1e3;for(var l=[],c=r.createElement("div"),d=0,h=this.items.length;d<h;d++){var u=this.items[d],g=r.createElement("input");if(g.setAttribute("type","button"),g.setAttribute("id",u.id),g.style.position="relative",g.style.top="50%",g.style.transform="translateY(-50%)","OT_colors"===u.id){g.style.webkitTransform="translateY(-85%)";var m=r.createElement("div");m.setAttribute("class","color-picker"),m.style.backgroundColor=this.backgroundColor,this.parent.appendChild(m);var f=new s(".color-picker",this.colors,{externalWindow:i.externalWindow});f.colorChosen(function(t){var e=r.getElementById("OT_colors");e.style.backgroundColor=t,n.forEach(function(e){e.changeColor(t)})});for(var p=r.querySelectorAll(".color-choice"),v=0;v<p.length;v++)p[v].style.display="inline-block",p[v].style.width="30px",p[v].style.height="30px",p[v].style.margin="5px",p[v].style.cursor="pointer",p[v].style.borderRadius="100%",p[v].style.opacity=.7,p[v].onmouseover=function(){this.style.opacity=1},p[v].onmouseout=function(){this.style.opacity=.7};g.setAttribute("class","OT_color"),g.style.marginLeft="10px",g.style.marginRight="10px",g.style.borderRadius="50%",g.style.backgroundColor=this.colors[0],g.style.width=this.iconWidth,g.style.height=this.iconHeight,g.style.paddingTop=this.buttonHeight.replace("px","")-this.iconHeight.replace("px","")+"px"}else g.style.background='url("'+u.icon+'") no-repeat',g.style.backgroundSize=this.iconWidth+" "+this.iconHeight,g.style.backgroundPosition="center",g.style.width=this.buttonWidth,g.style.height=this.buttonHeight;"Line Width"!==u.title||Array.isArray(u.items)||(u.items=[{id:"OT_line_width_2",title:"Line Width 2",size:2},{id:"OT_line_width_4",title:"Line Width 4",size:4},{id:"OT_line_width_6",title:"Line Width 6",size:6},{id:"OT_line_width_8",title:"Line Width 8",size:8},{id:"OT_line_width_10",title:"Line Width 10",size:10},{id:"OT_line_width_12",title:"Line Width 12",size:12},{id:"OT_line_width_14",title:"Line Width 14",size:14}]),u.items&&g.setAttribute("data-type","group"),g.setAttribute("data-col",u.title),g.style.border="none",g.style.cursor="pointer",l.push(g.outerHTML)}o.innerHTML=l.join(""),o.onclick=function(t){var i="group"===t.target.getAttribute("data-type"),o=t.target.getAttribute("data-col"),s=t.target.getAttribute("id");i?e.items.forEach(function(t){if(t.title===o){if(e.selectedGroup=t,t.items&&(c.setAttribute("class","OT_subpanel"),c.style.backgroundColor=e.backgroundColor,c.style.width="100%",c.style.height="100%",c.style.paddingLeft="15px",c.style.display="none",e.parent.appendChild(c),Array.isArray(t.items))){var i=[];"OT_line_width"===t.id?t.items.forEach(function(t){var o=r.createElement("div");o.setAttribute("data-col",t.title),o.setAttribute("id",t.id),o.style.position="relative",o.style.top="50%",o.style.transform="translateY(-50%)",o.style["float"]="left",o.style.width=e.buttonWidth,o.style.height=e.buttonHeight,o.style.border="none",o.style.cursor="pointer";var n=r.createElement("div");n.style.backgroundColor="#FFFFFF",n.style.width="80%",n.style.height=t.size+"px",n.style.position="relative",n.style.left="50%",n.style.top="50%",n.style.transform="translateX(-50%) translateY(-50%)",n.style.pointerEvents="none",o.appendChild(n),i.push(o.outerHTML)}):t.items.forEach(function(t){var o=r.createElement("input");o.setAttribute("type","button"),o.setAttribute("data-col",t.title),o.setAttribute("id",t.id),o.style.background='url("'+t.icon+'") no-repeat',o.style.position="relative",o.style.top="50%",o.style.transform="translateY(-50%)",o.style.backgroundSize=e.iconWidth+" "+e.iconHeight,o.style.backgroundPosition="center",o.style.width=e.buttonWidth,o.style.height=e.buttonHeight,o.style.border="none",o.style.cursor="pointer",i.push(o.outerHTML)}),c.innerHTML=i.join("")}"OT_shapes"===s||"OT_line_width"===s?(c&&(c.style.display="block"),f.close()):"OT_colors"===s&&(c&&(c.style.display="none"),f.open())}}):(e.items.forEach(function(t){if("Clear"!==t.title&&t.title===o){if(e.selectedItem){var i=r.getElementById(e.selectedItem.id);i&&(i.style.background='url("'+e.selectedItem.icon+'") no-repeat',i.style.backgroundSize=e.iconWidth+" "+e.iconHeight,i.style.backgroundPosition="center")}if(t.selectedIcon){var s=r.getElementById(t.id);s&&(s.style.background='url("'+t.selectedIcon+'") no-repeat',s.style.backgroundSize=e.iconWidth+" "+e.iconHeight,s.style.backgroundPosition="center")}return e.selectedItem=t,a(t),n.forEach(function(t){t.selectItem(e.selectedItem)}),!1}}),c.style.display="none"),e.cbs.forEach(function(t){t.call(e,s)})},c.onclick=function(t){var i="group"===t.target.getAttribute("data-type"),o=(t.target.getAttribute("data-col"),t.target.getAttribute("id"));c.style.display="none",i||e.selectedGroup.items.forEach(function(t){if("OT_clear"!==t.id&&t.id===o){if(e.selectedItem){var i=document.getElementById(e.selectedItem.id);i&&(i.style.background='url("'+e.selectedItem.icon+'") no-repeat',i.style.backgroundSize=e.iconWidth+" "+e.iconHeight,i.style.backgroundPosition="center")}if(t.selectedIcon){var s=document.getElementById(t.id);i&&(s.style.background='url("'+t.selectedIcon+'") no-repeat',s.style.backgroundSize=e.iconWidth+" "+e.iconHeight,s.style.backgroundPosition="center")}return e.selectedItem=t,a(t),n.forEach(function(t){t.selectItem(e.selectedItem)}),!1}}),e.cbs.forEach(function(t){t.call(e,o)})},r.getElementById("OT_clear").onclick=function(){n.forEach(function(t){t.clear()})}}},!this.externalWindow&&this.createPanel();var a=function(t){t.points||("OT_line"===t.id?e.selectedItem.points=[[0,0],[0,1]]:"OT_arrow"===t.id?e.selectedItem.points=[[0,1],[3,1],[3,0],[5,2],[3,4],[3,3],[0,3],[0,1]]:"OT_rect"===t.id?e.selectedItem.points=[[0,0],[1,0],[1,1],[0,1],[0,0]]:"OT_oval"===t.id&&(e.selectedItem.enableSmoothing=!0,e.selectedItem.points=[[0,.5],[.5+.5*Math.cos(5*Math.PI/4),.5+.5*Math.sin(5*Math.PI/4)],[.5,0],[.5+.5*Math.cos(7*Math.PI/4),.5+.5*Math.sin(7*Math.PI/4)],[1,.5],[.5+.5*Math.cos(Math.PI/4),.5+.5*Math.sin(Math.PI/4)],[.5,1],[.5+.5*Math.cos(3*Math.PI/4),.5+.5*Math.sin(3*Math.PI/4)],[0,.5],[.5+.5*Math.cos(5*Math.PI/4),.5+.5*Math.sin(5*Math.PI/4)]]))};this.itemClicked=function(t){this.cbs.push(t)},this.addCanvas=function(t){var e=this;t.link(e.session),t.colors(e.colors),n.push(t)},this.removeCanvas=function(t){n.forEach(function(e){var i=e.canvas();e.videoFeed.stream.connection.connectionId===t&&i.parentNode&&i.parentNode.removeChild(i)}),n=n.filter(function(e){return e.videoFeed.stream.connection.connectionId!==t})},this.remove=function(){try{o.parentNode.removeChild(o)}catch(t){console.log(t)}n.forEach(function(t){var e=t.canvas();e.parentNode&&e.parentNode.removeChild(e)}),n=[]}},OTSolution.Annotations.Analytics=function(){},OTSolution.Annotations.Analytics.logEvent=function(t){var e=t.payload||"";"object"==typeof e&&(e=JSON.stringify(e)),t.payload=e;var i=JSON.stringify(t),o=new XMLHttpRequest;o.open("POST","https://hlg.tokbox.com/prod/logging/ClientEvent",!0),o.setRequestHeader("Content-type","application/json"),o.send(i)},OTSolution.Annotations.Analytics.get_uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"==t?e:3&e|8;return i.toString(16)})};